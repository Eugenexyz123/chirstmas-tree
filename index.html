<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Grand Luxury Tree V22.0 - Cinematic Edition</title>
    <style>
        :root { --gold: #d4af37; --bg: #020205; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: -apple-system, sans-serif; }
        
        #loading-screen {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1a1b3a 0%, var(--bg) 100%);
            z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-card {
            width: 300px; padding: 40px; background: rgba(10,10,15,0.85); border-radius: 24px;
            border: 1px solid rgba(212, 175, 55, 0.4); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.9);
        }
        #progress-num { font-size: 42px; font-weight: 200; color: var(--gold); margin-bottom: 10px; }
        .bar-container { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        #bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #d4af37, #fceea7, #d4af37); transition: width 0.3s; }
        #status-log { font-size: 9px; color: var(--gold); margin-top: 15px; letter-spacing: 2px; opacity: 0.7; }

        .enter-btn {
            display: none; background: linear-gradient(135deg, #fceea7, #d4af37); color: #221a05;
            border: none; padding: 18px 0; width: 100%; font-size: 14px; font-weight: bold; 
            border-radius: 40px; cursor: pointer; margin-top: 25px; box-shadow: 0 0 20px rgba(212,175,55,0.4);
        }

        #ui-layer { position: absolute; top: env(safe-area-inset-top, 20px); right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .glass-btn { pointer-events: auto; padding: 12px 20px; background: rgba(0,0,0,0.6); border: 1.5px solid var(--gold); border-radius: 25px; color: #fceea7; font-size: 13px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }

        #v-preview { position: fixed; bottom: 30px; right: 30px; width: 90px; height: 125px; border: 2px solid var(--gold); border-radius: 15px; transform: scaleX(-1); object-fit: cover; z-index: 50; display: none; background: #000; box-shadow: 0 0 40px #000; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="loading-card">
        <div id="progress-num">0%</div>
        <div class="bar-container"><div id="bar-fill"></div></div>
        <div id="status-log">CONNECTING TO US CDN...</div>
        <button id="enter-node" class="enter-btn" onclick="activateApp()">ACTIVATE 3D SPACE</button>
    </div>
</div>

<div id="ui-layer">
    <label class="glass-btn">üì∏ Ê∑ªÂä†ÁÖßÁâá <input type="file" id="pic-up" accept="image/*" multiple hidden></label>
    <div class="glass-btn" onclick="handleAudio()">üéµ Èü≥‰πêÂàáÊç¢</div>
</div>

<video id="v-preview" autoplay playsinline muted></video>
<div id="canvas-container" style="position: absolute; inset:0;"></div>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/", "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

    let scene, camera, renderer, composer, clock = new THREE.Clock();
    let particles = [], orbitGroups = [], handLandmarker, video;
    let mode = 'TREE';
    
    // Âº∫Âà∂Èü≥‰πêÊøÄÊ¥ªË∑ØÂæÑ
    const bgm = new Audio('https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Kai_Engel/Chapter_One__Cold/Kai_Engel_-_04_-_Moonlight_Reprise.mp3');
    bgm.loop = true;

    const setStatus = (p, m) => {
        document.getElementById('bar-fill').style.width = p + '%';
        document.getElementById('progress-num').innerText = p + '%';
        document.getElementById('status-log').innerText = m;
    };

    async function init() {
        try {
            setStatus(15, "INITIALIZING HD RENDERER...");
            setupThree();
            setStatus(45, "FETCHING NEURAL DATA...");
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            setStatus(85, "DOWNLOADING HAND AI (15MB)...");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            setStatus(100, "READY");
            document.getElementById('enter-node').style.display = 'block';
        } catch (e) { setStatus(0, "RETRY REQUIRED"); }
    }

    function setupThree() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020205, 0.01);
        camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 60);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2.5)); // È´òÁîªË¥®ÂºÄÂêØ
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Ê†∏ÂøÉÔºöÂú£ËØûÊ†ëÂπ≤‰∏éÁâ©ÁêÜÊîØÊíë
        const trunkGeo = new THREE.CylinderGeometry(0.8, 3, 28, 12);
        const trunkMat = new THREE.MeshStandardMaterial({ color: 0x1a0d00, roughness: 1 });
        const trunk = new THREE.Mesh(trunkGeo, trunkMat);
        trunk.position.y = -2;
        scene.add(trunk);

        // Â§öÊ†∑ÂåñÁ≤æËá¥Á≤íÂ≠ê
        const leafMat = new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffaa00, emissiveIntensity: 1, metalness: 1 });
        const leafGeos = [new THREE.IcosahedronGeometry(0.2, 0), new THREE.OctahedronGeometry(0.15, 0)];
        
        for (let i = 0; i < 3500; i++) {
            const mesh = new THREE.Mesh(leafGeos[i%2], leafMat);
            const r = Math.pow(Math.random(), 1.4);
            const y = r * 28 - 14;
            const radius = (14 - y) * 0.42;
            const angle = r * 55 + Math.random() * Math.PI * 2;
            
            particles.push({
                mesh,
                tree: new THREE.Vector3(Math.cos(angle)*radius, y, Math.sin(angle)*radius),
                scatter: new THREE.Vector3().setFromSphericalCoords(30 + Math.random()*20, Math.random()*Math.PI, Math.random()*Math.PI*2),
                speed: 0.04 + Math.random()*0.05
            });
            scene.add(mesh);
        }

        // ËæâÂÖâÂêéÊúü
        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.6, 0.4, 0.85);
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);

        document.getElementById('pic-up').addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => createOrbitalPhoto(URL.createObjectURL(file)));
        });
    }

    function createOrbitalPhoto(src) {
        const loader = new THREE.TextureLoader();
        loader.load(src, (tex) => {
            tex.anisotropy = 16;
            tex.colorSpace = THREE.SRGBColorSpace;
            const m = new THREE.Mesh(new THREE.PlaneGeometry(6, 8), new THREE.MeshBasicMaterial({ map: tex, side: 2, transparent: true }));
            
            // ÂÖ≥ÈîÆÔºöÂàõÂª∫ÂÖ¨ËΩ¨‰∏≠ÂøÉÁªÑ
            const pivot = new THREE.Group();
            const orbitRadius = 15 + Math.random() * 10;
            const orbitSpeed = 0.005 + Math.random() * 0.01;
            
            m.position.set(orbitRadius, (Math.random()-0.5)*15, 0);
            pivot.add(m);
            scene.add(pivot);
            orbitGroups.push({ pivot, m, speed: orbitSpeed, state: 'ORBIT' });
        });
    }

    window.activateApp = async () => {
        video = document.getElementById('v-preview');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                video.style.display = "block";
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(()=>document.getElementById('loading-screen').style.display='none', 800);
            };
            // Ëß£ÂÜ≥ iOS Â£∞Èü≥ÈóÆÈ¢òÁöÑÊ†∏ÂøÉ
            await bgm.play();
            runAI();
            animate();
        } catch (e) { alert("PLEASE ALLOW CAMERA FOR AI"); }
    };

    function runAI() {
        if (handLandmarker && video.readyState >= 2) {
            const res = handLandmarker.detectForVideo(video, performance.now());
            if (res.landmarks?.length > 0) {
                const lm = res.landmarks[0];
                const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                if (d < 0.06) mode = 'FOCUS'; // ÊçèÂêàÔºöÊäìÂèñ
                else if (d > 0.16) mode = 'SCATTER'; // Âº†ÂºÄÔºöÁàÜË£Ç
                else mode = 'TREE';
            }
        }
        requestAnimationFrame(runAI);
    }

    function animate() {
        requestAnimationFrame(animate);
        const t = clock.getElapsedTime();
        
        particles.forEach((p, i) => {
            const dest = (mode === 'TREE') ? p.tree : p.scatter;
            p.mesh.position.lerp(dest, 0.06);
            p.mesh.scale.setScalar(1 + Math.sin(t*3 + i)*0.15);
        });

        orbitGroups.forEach(p => {
            if (mode === 'FOCUS') {
                const target = new THREE.Vector3(0, 0, -20).applyQuaternion(camera.quaternion).add(camera.position);
                p.m.position.lerp(target, 0.1);
                p.m.lookAt(camera.position);
            } else {
                p.pivot.rotation.y += p.speed; // ÂÖ¨ËΩ¨
                p.m.position.lerp(new THREE.Vector3(18, p.m.position.y, 0), 0.05); // ËΩ®ÈÅìÂõû‰Ωç
                p.m.lookAt(0, p.m.position.y, 0); // ÂßãÁªàÈù¢Âêë‰∏≠ÂøÉ
            }
        });

        composer.render();
    }

    window.handleAudio = () => bgm.paused ? bgm.play() : bgm.pause();
    init();
</script>
</body>
</html>
