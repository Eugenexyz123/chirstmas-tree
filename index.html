<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Luxury Tree - iOS Pro Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: -apple-system, sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top:0; left:0; z-index: 1; }
        
        /* å¯åŠ¨è¦†ç›–å±‚ï¼šè§£å†³ iOS æƒé™é”æ­»é—®é¢˜ */
        #start-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: radial-gradient(circle, #1a1a2e 0%, #020205 100%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .start-btn {
            padding: 20px 40px; font-size: 18px; color: #d4af37;
            background: rgba(212, 175, 55, 0.1); border: 2px solid #d4af37;
            border-radius: 50px; cursor: pointer; letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        /* é¡¶éƒ¨ UI */
        #ui-layer { position: absolute; top: env(safe-area-inset-top, 20px); width: 100%; display: flex; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 100; pointer-events: none; }
        .glass-btn { pointer-events: auto; padding: 12px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid gold; border-radius: 12px; color: gold; font-size: 12px; }

        #status-info { position: fixed; bottom: 30px; width: 100%; text-align: center; color: gold; font-size: 10px; z-index: 100; opacity: 0.7; }
        video#webcam-video { position: fixed; bottom: 10px; right: 10px; width: 80px; height: 60px; border: 1px solid gold; border-radius: 8px; transform: scaleX(-1); z-index: 50; background: #000; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="start-overlay">
    <div style="color: #d4af37; margin-bottom: 30px; font-size: 24px; font-weight: 200;">GOLDEN CHRISTMAS</div>
    <button class="start-btn" onclick="startExperience()">ç‚¹å‡»å¼€å¯ 3D äº¤äº’ä¹‹æ—…</button>
    <p style="color: #666; margin-top: 20px; font-size: 12px;">å»ºè®®åœ¨é™éŸ³å¼€å…³å…³é—­çš„çŠ¶æ€ä¸‹ä½¿ç”¨</p>
</div>

<div id="ui-layer">
    <label class="glass-btn">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡<input type="file" id="photo-upload" accept="image/*" multiple hidden></label>
    <div class="glass-btn" onclick="toggleBGM()">ğŸµ éŸ³ä¹å¼€å…³</div>
</div>

<div id="status-info">ç³»ç»ŸçŠ¶æ€ï¼šç­‰å¾…å¯åŠ¨</div>
<div id="canvas-container"></div>
<video id="webcam-video" autoplay playsinline muted></video>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/", "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

    let scene, camera, renderer, composer, particles = [], photos = [], handLandmarker;
    let videoElement, mode = 'TREE';
    const bgm = new Audio('https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Kai_Engel/Chapter_One__Cold/Kai_Engel_-_04_-_Moonlight_Reprise.mp3');
    bgm.loop = true;

    // æš´éœ²ç»™å…¨å±€æŒ‰é’®
    window.startExperience = async function() {
        const info = document.getElementById('status-info');
        info.innerText = "æ­£åœ¨è¯·æ±‚æˆæƒ...";
        
        try {
            // 1. åŒæ—¶è¯·æ±‚éŸ³é¢‘å’Œè§†é¢‘æˆæƒ
            await bgm.play(); 
            videoElement = document.getElementById('webcam-video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoElement.srcObject = stream;

            // 2. åˆå§‹åŒ– 3D å’Œ AI
            document.getElementById('start-overlay').style.display = 'none';
            initScene();
            await initAI();
        } catch (err) {
            alert("è¯·åœ¨å¼¹çª—ä¸­é€‰æ‹©â€˜å…è®¸è®¿é—®æ‘„åƒå¤´â€™ï¼Œå¹¶ç¡®ä¿æ‰‹æœºæœªå¤„äºé™éŸ³æ¨¡å¼");
            console.error(err);
        }
    };

    function initScene() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 45);

        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // åˆ›å»ºè±ªåç²’å­
        const group = new THREE.Group();
        const geo = new THREE.IcosahedronGeometry(0.15, 0);
        const mat = new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffaa00, metalness: 1 });

        for (let i = 0; i < 2500; i++) {
            const mesh = new THREE.Mesh(geo, mat);
            const ratio = Math.pow(Math.random(), 1.2);
            const y = ratio * 22 - 11;
            const r = (11 - y) * 0.35;
            const angle = ratio * 40 + Math.random() * Math.PI * 2;
            
            const p = {
                mesh,
                treePos: new THREE.Vector3(Math.cos(angle)*r, y, Math.sin(angle)*r),
                scatterPos: new THREE.Vector3().setFromSphericalCoords(20 + Math.random()*15, Math.random()*Math.PI, Math.random()*Math.PI*2)
            };
            mesh.position.copy(p.scatterPos);
            group.add(mesh);
            particles.push(p);
        }
        scene.add(group);
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));

        // åæœŸè¾‰å…‰
        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);

        animate();
    }

    async function initAI() {
        const info = document.getElementById('status-info');
        info.innerText = "AI æ¨¡å‹åŠ è½½ä¸­ (çº¦ 10 ç§’)...";
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        handLandmarker = await HandLandmarker.createFromOptions(vision, {
            baseOptions: { 
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                delegate: "GPU" 
            },
            runningMode: "VIDEO", numHands: 1
        });
        info.innerText = "ç³»ç»Ÿè¿è¡Œä¸­ | æ‰‹åŠ¿å·²æ¿€æ´»";
        detectHand();
    }

    function detectHand() {
        if (handLandmarker && videoElement.readyState >= 2) {
            const results = handLandmarker.detectForVideo(videoElement, performance.now());
            if (results.landmarks?.length > 0) {
                const dist = Math.hypot(results.landmarks[0][4].x - results.landmarks[0][8].x, results.landmarks[0][4].y - results.landmarks[0][8].y);
                mode = (dist < 0.05) ? 'GRAB' : 'TREE';
            }
        }
        requestAnimationFrame(detectHand);
    }

    function animate() {
        requestAnimationFrame(animate);
        particles.forEach(p => {
            const target = (mode === 'GRAB') ? p.scatterPos : p.treePos;
            p.mesh.position.lerp(target, 0.06);
        });
        
        photos.forEach(p => {
            if (mode === 'GRAB') {
                const camForward = new THREE.Vector3(0,0,-15).applyQuaternion(camera.quaternion).add(camera.position);
                p.mesh.position.lerp(camPos, 0.1);
                p.mesh.lookAt(camera.position);
            } else {
                p.mesh.position.lerp(p.origPos, 0.05);
            }
        });

        composer.render();
    }

    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    document.getElementById('photo-upload').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const tex = new THREE.TextureLoader().load(ev.target.result);
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(6, 7), new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide }));
                mesh.position.set((Math.random()-0.5)*20, (Math.random()-0.5)*15, (Math.random()-0.5)*10);
                scene.add(mesh);
                photos.push({ mesh, origPos: mesh.position.clone() });
            };
            reader.readAsDataURL(file);
        });
    });

    window.toggleBGM = () => { bgm.paused ? bgm.play() : bgm.pause(); };
</script>
</body>
</html>
