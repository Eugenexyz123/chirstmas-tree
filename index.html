<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Grand Luxury Tree - Enterprise v18.5</title>
    <style>
        :root {
            --accent: #d4af37;
            --bg: #020205;
            --panel: rgba(15, 15, 25, 0.85);
        }
        body { margin: 0; overflow: hidden; background-color: var(--bg); font-family: -apple-system, system-ui, sans-serif; color: white; -webkit-user-select: none; }
        
        /* 1. å¼ºåˆ¶å¯åŠ¨å±‚ï¼šè§£å†³ iOS æƒé™ä¸å¼¹çª—é—®é¢˜ */
        #auth-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1a1b3a 0%, var(--bg) 100%);
            z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease;
        }
        .auth-card { text-align: center; padding: 40px; border-radius: 30px; border: 1px solid rgba(212, 175, 55, 0.3); background: var(--panel); backdrop-filter: blur(20px); }
        .start-btn {
            background: var(--accent); color: black; border: none; padding: 18px 40px; 
            font-size: 16px; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.4); margin-top: 20px;
        }

        /* 2. è¿›åº¦æ¡ UI */
        #loading-container { width: 240px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 20px; overflow: hidden; display: none; }
        #loading-bar { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s; }
        #status-text { font-size: 10px; color: var(--accent); margin-top: 8px; letter-spacing: 2px; text-transform: uppercase; }

        /* 3. ä¸» UI ç•Œé¢ */
        #canvas-container { position: absolute; inset: 0; z-index: 1; }
        .ui-panel { position: absolute; z-index: 100; pointer-events: none; }
        #top-bar { top: env(safe-area-inset-top, 20px); right: 20px; display: flex; gap: 12px; }
        #side-menu { bottom: 40px; left: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .glass-btn {
            pointer-events: auto; background: var(--panel); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 12px 18px; border-radius: 15px; font-size: 13px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; align-items: center; gap: 8px;
        }
        .glass-btn i { color: var(--accent); }

        #webcam-preview {
            position: fixed; bottom: 20px; right: 20px; width: 90px; height: 120px; 
            border-radius: 12px; border: 1px solid var(--accent); background: black;
            transform: scaleX(-1); object-fit: cover; z-index: 50; display: none;
        }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <div style="font-size: 28px; letter-spacing: 5px; color: var(--accent); margin-bottom: 10px;">LUXURY TREE</div>
        <div style="font-size: 12px; opacity: 0.6; margin-bottom: 20px;">V18.5 ENTERPRISE EDITION</div>
        <button class="start-btn" onclick="requestPermissions()">è¿›å…¥ 3D äº¤äº’ç©ºé—´</button>
        <div id="loading-container"><div id="loading-bar"></div></div>
        <div id="status-text">ç­‰å¾…æŒ‡ä»¤</div>
    </div>
</div>

<div id="top-bar" class="ui-panel">
    <label class="glass-btn"><i>ğŸ“·</i> ä¸Šä¼ ç…§ç‰‡<input type="file" id="photo-input" accept="image/*" multiple hidden></label>
    <div class="glass-btn" onclick="toggleMusic()"><i>ğŸµ</i> éŸ³ä¹</div>
</div>

<div id="side-menu" class="ui-panel">
    <div class="glass-btn" onclick="setMode('TREE')">ğŸ„ åœ£è¯å½¢æ€</div>
    <div class="glass-btn" onclick="setMode('SCATTER')">âœ¨ æµªæ¼«æ˜Ÿäº‘</div>
    <div id="gesture-indicator" style="font-size: 9px; color: var(--accent); text-align: center; margin-top: 5px;">æ‰‹åŠ¿ï¼šæœªæ¿€æ´»</div>
</div>

<video id="webcam-preview" autoplay playsinline muted></video>
<div id="canvas-container"></div>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/", "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

    let scene, camera, renderer, composer, particles = [], photos = [], mainGroup;
    let handLandmarker, videoElement, mode = 'TREE';
    const bgm = new Audio('https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Kai_Engel/Chapter_One__Cold/Kai_Engel_-_04_-_Moonlight_Reprise.mp3');
    bgm.loop = true;

    // æ ¸å¿ƒï¼šiOS æƒé™è¯·æ±‚å‡½æ•°
    window.requestPermissions = async function() {
        const bar = document.getElementById('loading-bar');
        const container = document.getElementById('loading-container');
        const status = document.getElementById('status-text');
        
        container.style.display = 'block';
        status.innerText = "æ­£åœ¨è¯·æ±‚ç›¸æœºæƒé™...";
        bar.style.width = "10%";

        try {
            // 1. åŒæ—¶è¯·æ±‚ç›¸æœºä¸éŸ³é¢‘
            videoElement = document.getElementById('webcam-preview');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoElement.srcObject = stream;
            videoElement.style.display = "block";
            await bgm.play(); // è§£é”éŸ³é¢‘

            // 2. åŠ è½½ MediaPipe æ¨¡å‹
            status.innerText = "åˆå§‹åŒ– AI å¼•æ“ (30%)...";
            bar.style.width = "30%";
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            
            status.innerText = "ä¸‹è½½ç¥ç»ç½‘ç»œæ¨¡å‹ (70%)...";
            bar.style.width = "70%";
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { 
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU" 
                },
                runningMode: "VIDEO", numHands: 1
            });

            bar.style.width = "100%";
            status.innerText = "å¯åŠ¨å®Œæˆ";
            
            setTimeout(() => {
                document.getElementById('auth-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('auth-overlay').style.display='none', 600);
                initApp();
            }, 500);

        } catch (err) {
            status.innerText = "é”™è¯¯ï¼šè¯·åŠ¡å¿…å…è®¸ç›¸æœºæƒé™";
            console.error(err);
        }
    };

    function initApp() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 50);

        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        mainGroup = new THREE.Group();
        scene.add(mainGroup);

        // ä¼˜åŒ–ï¼šå¤šæ ·åŒ–ç²’å­ç³»ç»Ÿ (å¼•å…¥ä¸åŒå‡ ä½•å½¢çŠ¶)
        const geometries = [
            new THREE.IcosahedronGeometry(0.15, 0), // ç¢é’»
            new THREE.BoxGeometry(0.12, 0.12, 0.12), // æ–¹æ™¶
            new THREE.OctahedronGeometry(0.18, 0) // æ˜ŸèŠ’
        ];
        
        const mat = new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xaa8800, metalness: 1, roughness: 0.1 });

        for (let i = 0; i < 3000; i++) {
            const geo = geometries[Math.floor(Math.random() * geometries.length)];
            const mesh = new THREE.Mesh(geo, mat);
            
            const ratio = Math.pow(Math.random(), 1.2);
            const y = ratio * 24 - 12;
            const r = (12 - y) * 0.35;
            const angle = ratio * 45 + Math.random() * Math.PI * 2;

            const p = {
                mesh,
                treePos: new THREE.Vector3(Math.cos(angle)*r, y, Math.sin(angle)*r),
                scatterPos: new THREE.Vector3().setFromSphericalCoords(25 + Math.random()*15, Math.random()*Math.PI, Math.random()*Math.PI*2),
                speed: 0.03 + Math.random() * 0.04
            };
            mesh.position.copy(p.scatterPos);
            mainGroup.add(mesh);
            particles.push(p);
        }

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const pointLight = new THREE.PointLight(0xffd700, 2, 50);
        pointLight.position.set(0, 10, 10);
        scene.add(pointLight);

        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        document.getElementById('photo-input').addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const tex = new THREE.TextureLoader().load(ev.target.result);
                    const mesh = new THREE.Mesh(new THREE.PlaneGeometry(6, 7.5), new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide }));
                    mesh.position.set((Math.random()-0.5)*20, (Math.random()-0.5)*15, (Math.random()-0.5)*10);
                    scene.add(mesh);
                    photos.push({ mesh, origPos: mesh.position.clone() });
                };
                reader.readAsDataURL(file);
            });
        });

        runAI();
        animate();
    }

    function runAI() {
        if (handLandmarker && videoElement.readyState >= 2) {
            const results = handLandmarker.detectForVideo(videoElement, performance.now());
            const indicator = document.getElementById('gesture-indicator');
            if (results.landmarks?.length > 0) {
                const dist = Math.hypot(results.landmarks[0][4].x - results.landmarks[0][8].x, results.landmarks[0][4].y - results.landmarks[0][8].y);
                if (dist < 0.05) {
                    mode = 'FOCUS';
                    indicator.innerText = "æ‰‹åŠ¿ï¼šæŠ“å–å›¾ç‰‡";
                } else if (dist > 0.15) {
                    mode = 'SCATTER';
                    indicator.innerText = "æ‰‹åŠ¿ï¼šæ˜Ÿäº‘æ•£å¼€";
                } else {
                    mode = 'TREE';
                    indicator.innerText = "æ‰‹åŠ¿ï¼šåœ£è¯å½¢æ€";
                }
            }
        }
        requestAnimationFrame(runAI);
    }

    function animate() {
        requestAnimationFrame(animate);
        const time = Date.now() * 0.001;
        
        particles.forEach((p, i) => {
            const target = (mode === 'TREE') ? p.treePos : p.scatterPos;
            p.mesh.position.lerp(target, p.speed);
            p.mesh.rotation.x += 0.01;
            p.mesh.scale.setScalar(1 + Math.sin(time * 2 + i) * 0.1);
        });

        photos.forEach(p => {
            if (mode === 'FOCUS') {
                const targetPos = new THREE.Vector3(0,0,-18).applyQuaternion(camera.quaternion).add(camera.position);
                p.mesh.position.lerp(targetPos, 0.1);
                p.mesh.lookAt(camera.position);
            } else {
                p.mesh.position.lerp(p.origPos, 0.05);
                p.mesh.rotation.y += 0.005;
            }
        });

        mainGroup.rotation.y += 0.003;
        composer.render();
    }

    window.toggleMusic = () => { bgm.paused ? bgm.play() : bgm.pause(); };
    window.setMode = (m) => mode = m;
</script>
</body>
</html>
