<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Grand Luxury Tree v18.0 - Professional Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: -apple-system, sans-serif; -webkit-user-select: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; z-index: 1; }
        
        /* Â•¢ÂçéÈáëËâ≤ UI Ê†∑Âºè */
        .glass-ui {
            position: absolute; padding: 12px; background: rgba(10, 10, 15, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.25); border-radius: 16px; color: #d4af37;
            z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        #left-sidebar { top: 90px; left: 15px; width: 150px; display: flex; flex-direction: column; gap: 8px; }
        #top-controls { top: env(safe-area-inset-top, 20px); right: 15px; display: flex; gap: 8px; }
        
        .btn {
            background: rgba(212, 175, 55, 0.1); border: 1px solid #d4af37;
            color: #fceea7; padding: 10px; border-radius: 10px; font-size: 11px;
            text-align: center; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { background: rgba(212, 175, 55, 0.3); transform: scale(0.95); }

        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #020205; z-index: 1000; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; transition: opacity 0.8s ease-in-out;
        }
        .loading-ring { width: 50px; height: 50px; border: 2px solid rgba(212, 175, 55, 0.1); border-top: 2px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #title-container { position: absolute; top: 12%; width: 100%; text-align: center; z-index: 5; pointer-events: none; }
        .title-line { margin: 0; color: #fceea7; text-shadow: 0 0 15px rgba(212, 175, 55, 0.4); font-size: 32px; letter-spacing: 2px; }

        input[type="file"] { display: none; }
        .hidden { opacity: 0 !important; pointer-events: none !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="loading-ring"></div>
    <div id="status-text" style="color: #d4af37; margin-top: 25px; font-size: 11px; letter-spacing: 3px;">INITIALIZING SYSTEM...</div>
</div>

<div id="title-container">
    <h1 class="title-line" style="font-weight: 300;">MERRY</h1>
    <h1 class="title-line" style="font-weight: 700;">CHRISTMAS</h1>
</div>

<div id="top-controls">
    <label class="btn">üì∏ ‰∏ä‰º†ÁÖßÁâá <input type="file" id="photo-upload" accept="image/*" multiple></label>
    <div class="btn" onclick="toggleMusic()">üéµ Èü≥È¢ë</div>
</div>

<div id="left-sidebar" class="glass-ui">
    <div id="gesture-status" style="font-size: 10px; text-align: center; margin-bottom: 5px; opacity: 0.7;">ÊÑüÂ∫î‰∏≠...</div>
    <div class="btn" onclick="setMode('TREE')">üéÑ Âú£ËØûÊ†ë</div>
    <div class="btn" onclick="setMode('SCATTER')">‚ú® Êòü‰∫ë</div>
</div>

<div id="canvas-container"></div>
<video id="webcam-video" autoplay playsinline muted style="display:none"></video>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/", "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

    let scene, camera, renderer, composer, clock = new THREE.Clock();
    let particles = [], photoObjects = [], mainGroup;
    let handLandmarker, videoElement, mode = 'TREE';
    let isMusicPlaying = false;
    let bgm = new Audio('https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Kai_Engel/Chapter_One__Cold/Kai_Engel_-_04_-_Moonlight_Reprise.mp3');
    bgm.loop = true;

    async function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 50);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        mainGroup = new THREE.Group();
        scene.add(mainGroup);

        createParticles();
        setupPostProcessing();
        await setupAI();

        document.getElementById('photo-upload').addEventListener('change', handleUpload);
        
        const loader = document.getElementById('loader');
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 800);

        animate();
    }

    async function setupAI() {
        const status = document.getElementById('status-text');
        videoElement = document.getElementById('webcam-video');
        
        try {
            status.innerText = "Ê≠£Âú®ËØ∑Ê±ÇÊëÑÂÉèÂ§¥ÊùÉÈôê...";
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoElement.srcObject = stream;

            status.innerText = "Ê≠£Âú®ËøûÊé•Ê®°ÂûãÊúçÂä°Âô® (0%)...";
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");

            status.innerText = "Ê≠£Âú®‰∏ãËΩΩÁ•ûÁªèÁΩëÁªúÊ®°Âûã (50%)...";
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { 
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, 
                    delegate: "GPU" 
                },
                runningMode: "VIDEO", numHands: 1
            });

            status.innerText = "Á≥ªÁªüÂ∞±Áª™ÔºåÂºÄÂßãÊ∏≤ÊüìÔºÅ";
            detectHand();
        } catch (e) {
            console.error(e);
            status.innerText = "ÊâãÂäøÂêØÂä®Â§±Ë¥•ÔºåÊîØÊåÅÊâãÂä®Êìç‰Ωú";
            setTimeout(() => { document.getElementById('loader').style.display='none'; }, 2000);
        }
    }

    function createParticles() {
        const geo = new THREE.IcosahedronGeometry(0.18, 0);
        const mat = new THREE.MeshStandardMaterial({ 
            color: 0xffd700, emissive: 0xffaa00, emissiveIntensity: 0.5, metalness: 1, roughness: 0 
        });

        for (let i = 0; i < 2800; i++) {
            const mesh = new THREE.Mesh(geo, mat);
            const ratio = Math.pow(Math.random(), 1.2);
            const y = ratio * 24 - 12;
            const r = (12 - y) * 0.35;
            const angle = ratio * 45 + Math.random() * Math.PI * 2;
            
            const p = {
                mesh: mesh,
                treePos: new THREE.Vector3(Math.cos(angle)*r, y, Math.sin(angle)*r),
                scatterPos: new THREE.Vector3().setFromSphericalCoords(25 + Math.random()*15, Math.random()*Math.PI, Math.random()*Math.PI*2),
                speed: 0.03 + Math.random() * 0.04
            };
            mesh.position.copy(p.scatterPos);
            mainGroup.add(mesh);
            particles.push(p);
        }
    }

    function handleUpload(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const tex = new THREE.TextureLoader().load(event.target.result);
                const mesh = new THREE.Mesh(
                    new THREE.PlaneGeometry(5, 6), 
                    new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide })
                );
                mesh.position.set((Math.random()-0.5)*20, (Math.random()-0.5)*10, (Math.random()-0.5)*10);
                scene.add(mesh);
                photoObjects.push({ mesh, originalPos: mesh.position.clone(), state: 'IDLE' });
            };
            reader.readAsDataURL(file);
        });
    }

    function detectHand() {
        if (handLandmarker && videoElement.readyState >= 2) {
            const results = handLandmarker.detectForVideo(videoElement, performance.now());
            const statusLabel = document.getElementById('gesture-status');
            if (results.landmarks?.length > 0) {
                const lm = results.landmarks[0];
                const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                if (dist < 0.05) {
                    mode = 'FOCUS';
                    statusLabel.innerText = "‚ú® Ê≠£Âú®ÊäìÂèñÁÖßÁâá";
                } else if (dist > 0.15) {
                    mode = 'SCATTER';
                    statusLabel.innerText = "üåü Êòü‰∫ëÊ®°Âºè";
                } else {
                    mode = 'TREE';
                    statusLabel.innerText = "üéÑ Âú£ËØûÊ†ëÊ®°Âºè";
                }
            }
        }
        requestAnimationFrame(detectHand);
    }

    function setupPostProcessing() {
        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.4, 0.4, 0.85);
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);
    }

    function animate() {
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        const dt = clock.getDelta();

        particles.forEach(p => {
            const dest = (mode === 'SCATTER' || mode === 'FOCUS') ? p.scatterPos : p.treePos;
            p.mesh.position.lerp(dest, 0.05);
            p.mesh.material.emissiveIntensity = 0.5 + Math.sin(time * 2 + p.mesh.id) * 0.3;
        });

        photoObjects.forEach(p => {
            if (mode === 'FOCUS') {
                const camPos = new THREE.Vector3(0,0,-15).applyQuaternion(camera.quaternion).add(camera.position);
                p.mesh.position.lerp(camPos, 0.1);
                p.mesh.lookAt(camera.position);
            } else {
                p.mesh.position.lerp(p.originalPos, 0.05);
                p.mesh.rotation.y += 0.01;
            }
        });

        mainGroup.rotation.y += 0.003;
        composer.render();
    }

    window.setMode = (m) => mode = m;
    window.toggleMusic = () => {
        if (isMusicPlaying) bgm.pause(); else bgm.play();
        isMusicPlaying = !isMusicPlaying;
    };
    
    // ÈÄÇÈÖç iPhone Ëß¶Êë∏ÂêØÂä®Èü≥È¢ë
    window.addEventListener('touchstart', () => { if(!renderer) init(); }, { once: true });
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
    });
    init();
</script>
</body>
</html>
