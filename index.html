<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grand Luxury Tree v17.6.5 - Pro Mobile</title>
    <style>
        /* æ ¸å¿ƒåŸºç¡€è®¾ç½® */
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Microsoft YaHei', sans-serif; -webkit-user-select: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&family=Ma+Shan+Zheng&display=swap');

        /* UI è§†è§‰ï¼šé’ˆå¯¹ç§»åŠ¨ç«¯ä¼˜åŒ–äº†è§¦æ‘¸åŒºåŸŸ */
        :root {
            --glass-bg: rgba(20, 20, 25, 0.85);
            --accent-gold: #d4af37;
            --ui-scale: 0.85; 
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: auto;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ é¿è®© */
        #top-right-controls { position: absolute; top: env(safe-area-inset-top, 20px); right: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 50; }
        
        #left-sidebar { 
            position: absolute; top: 70px; left: 15px; width: 180px; 
            max-height: 60vh; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; z-index: 20; 
            transform: scale(var(--ui-scale)); transform-origin: top left;
            transition: opacity 0.3s;
        }

        .elegant-btn {
            background: rgba(212, 175, 55, 0.15); border: 1px solid var(--accent-gold);
            color: #fff; padding: 10px; font-size: 12px; border-radius: 8px;
            text-align: center; text-transform: uppercase;
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 2px solid rgba(212, 175, 55, 0.2); border-top: 2px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #title-container { position: absolute; top: 15%; width: 100%; text-align: center; pointer-events: none; z-index: 5; }
        .title-line { margin: 0; color: #fceea7; text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); font-size: 40px; }

        /* éšè—çš„åŸç”Ÿæ‘„åƒå¤´é¢„è§ˆï¼Œç”¨äºæ‰‹åŠ¿è®¡ç®— */
        #webcam-video { position: fixed; width: 100px; height: 75px; bottom: 10px; right: 10px; border: 1px solid gold; transform: scaleX(-1); border-radius: 5px; z-index: 100; background: #000; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div id="status-text" style="color: #d4af37; margin-top: 20px; font-size: 12px; letter-spacing: 2px;">åˆå§‹åŒ– 3D å¼•æ“ä¸ AI æ¨¡å‹...</div>
</div>

<div id="title-container">
    <h1 id="display-line1" class="title-line" style="font-family: 'Cinzel';">Merry</h1>
    <h1 id="display-line2" class="title-line" style="font-family: 'Great Vibes';">Christmas</h1>
</div>

<div id="canvas-container"></div>

<div id="top-right-controls">
    <button class="elegant-btn glass-panel" onclick="toggleUI()">ğŸ‘ éšè—ç•Œé¢</button>
    <button class="elegant-btn glass-panel" onclick="toggleMusic()">ğŸµ æ’­æ”¾éŸ³ä¹</button>
</div>

<div id="left-sidebar" class="glass-panel" style="padding: 15px;">
    <div style="color:gold; font-size:14px; text-align:center; margin-bottom:10px;">åœºæ™¯æ§åˆ¶</div>
    <button class="elegant-btn" style="width:100%; margin-bottom:5px;" onclick="setMode('TREE')">ğŸ„ èšåˆå½¢æ€</button>
    <button class="elegant-btn" style="width:100%; margin-bottom:5px;" onclick="setMode('SCATTER')">âœ¨ æ˜Ÿäº‘æ•£å¼€</button>
    <div style="color:#aaa; font-size:10px; margin-top:10px;">æ‰‹åŠ¿æç¤ºï¼š<br>æåˆæ‰‹æŒ‡ -> æŠ“å–ç…§ç‰‡<br>å¼ å¼€æ‰‹æŒ -> æ•£å¼€ç²’å­</div>
</div>

<video id="webcam-video" autoplay playsinline muted></video>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/", "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

    // é…ç½®å‚æ•°
    const CONFIG = {
        particleCount: 2500,
        treeHeight: 22,
        treeRadius: 8,
        colors: { gold: 0xffd700, white: 0xffffff, bg: 0x050505 }
    };

    let scene, camera, renderer, composer, mainGroup, particles = [];
    let handLandmarker, videoElement;
    let mode = 'TREE';
    let isMusicPlaying = false;
    const bgm = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'); // é»˜è®¤æµ‹è¯•éŸ³ä¹
    bgm.loop = true;

    async function init() {
        // 1. åˆå§‹åŒ– Three.js åœºæ™¯
        scene = new THREE.Scene();
        scene.background = new THREE.Color(CONFIG.colors.bg);
        
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 45);

        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        mainGroup = new THREE.Group();
        scene.add(mainGroup);

        // 2. åˆ›å»ºè±ªåç²’å­ç³»ç»Ÿ
        createParticles();
        setupLights();
        setupPostProcessing();

        // 3. åˆå§‹åŒ– AI æ‰‹åŠ¿è¯†åˆ«
        await initAI();

        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500);

        animate();
    }

    function setupLights() {
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);
        const point = new THREE.PointLight(0xffd700, 2, 50);
        point.position.set(0, 10, 10);
        scene.add(point);
    }

    function createParticles() {
        const geo = new THREE.IcosahedronGeometry(0.2, 0);
        const mat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.8, roughness: 0.2, emissive: 0x443300 });

        for (let i = 0; i < CONFIG.particleCount; i++) {
            const mesh = new THREE.Mesh(geo, mat);
            const p = {
                mesh: mesh,
                posTree: new THREE.Vector3(),
                posScatter: new THREE.Vector3((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*50),
                speed: 0.03 + Math.random() * 0.05
            };

            // åœ£è¯æ ‘æ•°å­¦æ¨¡å‹
            const t = Math.pow(Math.random(), 0.8);
            const y = (t * CONFIG.treeHeight) - (CONFIG.treeHeight / 2);
            const r = CONFIG.treeRadius * (1 - t) * (0.8 + Math.random() * 0.4);
            const angle = t * 40 + Math.random() * Math.PI * 2;
            p.posTree.set(Math.cos(angle) * r, y, Math.sin(angle) * r);

            mesh.position.copy(p.posScatter);
            mainGroup.add(mesh);
            particles.push(p);
        }
    }

    function setupPostProcessing() {
        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85);
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);
    }

    async function initAI() {
        videoElement = document.getElementById('webcam-video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoElement.srcObject = stream;
            
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            predict();
        } catch (e) {
            console.warn("Camera or AI load failed:", e);
            document.getElementById('status-text').innerText = "æ‰‹åŠ¿åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ä½¿ç”¨æŒ‰é’®æ§åˆ¶";
        }
    }

    let lastTime = -1;
    function predict() {
        if (videoElement.currentTime !== lastTime) {
            const results = handLandmarker.detectForVideo(videoElement, performance.now());
            if (results.landmarks && results.landmarks.length > 0) {
                const lm = results.landmarks[0];
                const distance = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                if (distance < 0.05) mode = 'TREE'; // æåˆ
                else if (distance > 0.15) mode = 'SCATTER'; // å¼ å¼€
            }
            lastTime = videoElement.currentTime;
        }
        requestAnimationFrame(predict);
    }

    function animate() {
        requestAnimationFrame(animate);
        const time = Date.now() * 0.001;

        particles.forEach((p, i) => {
            const target = (mode === 'TREE') ? p.posTree : p.posScatter;
            p.mesh.position.lerp(target, p.speed);
            p.mesh.rotation.y += 0.01;
            if(mode === 'TREE') p.mesh.position.y += Math.sin(time + i) * 0.01;
        });

        mainGroup.rotation.y += 0.005;
        composer.render();
    }

    // äº¤äº’å‡½æ•°
    window.setMode = (m) => mode = m;
    window.toggleUI = () => {
        const sidebar = document.getElementById('left-sidebar');
        sidebar.style.opacity = sidebar.style.opacity === '0' ? '1' : '0';
    };
    window.toggleMusic = () => {
        if (isMusicPlaying) bgm.pause();
        else bgm.play().catch(e => alert("è¯·ç‚¹å‡»å±å¹•ä»¥å…è®¸æ’­æ”¾éŸ³ä¹"));
        isMusicPlaying = !isMusicPlaying;
    };

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
</script>
</body>
</html>
