<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Christmas Tree ‚Äì iPhone Edition</title>

<style>
body {
    margin: 0;
    background: #050508;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    color: white;
}
#ui {
    position: fixed;
    top: env(safe-area-inset-top,20px);
    right: 20px;
    z-index: 10;
    display: flex;
    gap: 10px;
}
.btn {
    padding: 10px 16px;
    border-radius: 20px;
    background: rgba(0,0,0,.6);
    border: 1px solid #d4af37;
    color: #fceea7;
    font-size: 12px;
}
</style>
</head>

<body>

<div id="ui">
    <label class="btn">
        üì∏ ÁÖßÁâá
        <input type="file" id="upload" accept="image/*" multiple hidden>
    </label>
    <button class="btn" id="musicBtn">üéµ Èü≥‰πê</button>
</div>

<div id="canvas"></div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

let scene, camera, renderer, composer;
let photoGroup = new THREE.Group();
let clock = new THREE.Clock();

/* ================== Âú∫ÊôØ ================== */
scene = new THREE.Scene();

camera = new THREE.PerspectiveCamera(
    50,
    window.innerWidth / window.innerHeight,
    0.1,
    500
);
camera.position.set(0, 6, 45);

renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
renderer.toneMapping = THREE.ReinhardToneMapping;
document.getElementById('canvas').appendChild(renderer.domElement);

/* ================== ÂêéÊúü ================== */
composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
composer.addPass(
    new UnrealBloomPass(
        new THREE.Vector2(innerWidth, innerHeight),
        1.6, 0.4, 0.8
    )
);

/* ================== ÂÖâ ================== */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dir = new THREE.DirectionalLight(0xffffff, 0.6);
dir.position.set(10,20,10);
scene.add(dir);

/* ================== Ê†ëÂπ≤ ================== */
const trunk = new THREE.Mesh(
    new THREE.CylinderGeometry(0.8,1.2,26,12),
    new THREE.MeshStandardMaterial({ color: 0x2b1608 })
);
scene.add(trunk);

/* ================== ÊùæÈíàÔºàPointsÔºâ ================== */
const needleCount = 12000;
const pos = new Float32Array(needleCount * 3);

for (let i=0;i<needleCount;i++){
    const y = Math.random()*26 - 13;
    const r = (13 - y)*0.45*Math.random();
    const a = Math.random()*Math.PI*2;

    pos[i*3]   = Math.cos(a)*r;
    pos[i*3+1] = y;
    pos[i*3+2] = Math.sin(a)*r;
}

const needleGeo = new THREE.BufferGeometry();
needleGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));

const needleMat = new THREE.PointsMaterial({
    color: 0x0f6b3a,
    size: 0.25,
    sizeAttenuation: true
});

scene.add(new THREE.Points(needleGeo, needleMat));

/* ================== ÂΩ©ÁÅØÔºàSpriteÔºâ ================== */
const glowTex = new THREE.TextureLoader().load('./glow.png');

for(let i=0;i<220;i++){
    const mat = new THREE.SpriteMaterial({
        map: glowTex,
        color: new THREE.Color().setHSL(Math.random(),1,.6),
        blending: THREE.AdditiveBlending,
        transparent:true
    });
    const s = new THREE.Sprite(mat);

    const y = Math.random()*26 - 13;
    const r = (13 - y)*0.45;
    const a = Math.random()*Math.PI*2;

    s.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
    s.scale.set(1.2,1.2,1);
    scene.add(s);
}

/* ================== ÊòüÊòü ================== */
const star = new THREE.Mesh(
    new THREE.IcosahedronGeometry(2,1),
    new THREE.MeshStandardMaterial({
        color:0xfff3b0,
        emissive:0xffe066,
        emissiveIntensity:3
    })
);
star.position.y = 14;
scene.add(star);

/* ================== ÁÖßÁâá ================== */
scene.add(photoGroup);

upload.onchange = e=>{
    [...e.target.files].forEach(file=>{
        const url = URL.createObjectURL(file);
        const tex = new THREE.TextureLoader().load(url,()=>{
            URL.revokeObjectURL(url);
        });
        tex.colorSpace = THREE.SRGBColorSpace;
        tex.anisotropy = renderer.capabilities.getMaxAnisotropy();

        const m = new THREE.Mesh(
            new THREE.PlaneGeometry(6,7.5),
            new THREE.MeshBasicMaterial({map:tex,transparent:true})
        );
        const a = Math.random()*Math.PI*2;
        const h = (Math.random()-0.5)*18;
        m.position.set(Math.cos(a)*15,h,Math.sin(a)*15);
        m.lookAt(0,h,0);
        photoGroup.add(m);
    });
};

/* ================== Èü≥‰πê ================== */
const bgm = new Audio('./music.mp3');
bgm.loop = true;
let audioOn = false;

musicBtn.onclick = async ()=>{
    if(!audioOn){
        await bgm.play();
        audioOn = true;
    }else{
        bgm.paused ? bgm.play() : bgm.pause();
    }
};

/* ================== Âä®Áîª ================== */
function animate(){
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();
    photoGroup.rotation.y += 0.003;
    star.rotation.y = t*0.6;
    composer.render();
}
animate();

window.onresize = ()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
    composer.setSize(innerWidth,innerHeight);
};
</script>

</body>
</html>
